<div class="m-product-card">
    {%- liquid
        assign qty_rules = false
        if product.selected_or_first_available_variant.quantity_rule.min > 1 or product.selected_or_first_available_variant.quantity_rule.max != null or product.selected_or_first_available_variant.quantity_rule.increment > 1
        assign qty_rules = true
        endif
        
        assign section_id = section_id | default: section.id | default: 'm-product-card'
        assign product_form_id = 'quick-add-' | append: section_id | append: '-' | append: product.id
    -%}

    <div class="m-product-card-image" onclick="if (!event.target.closest('.filter-button')) { document.location = '{{ product.url }}'; }" style="background-image: url({{ product.featured_image | image_url: width: 500 }})">
      {%- if product.available == false -%}
        <div class="m-product-card-sold-out-badge">
          {{ 'products.product.sold_out' | t }}
        </div>
      {%- else -%}
        <button
          type="button"
          class="filter-button"
          data-quick-view-trigger
          data-product-id="{{ product.id }}"
          data-product-handle="{{ product.handle }}"
          data-product-title="{{ product.title | escape }}"
          data-product-price="{{ product.price }}"
          data-product-featured-image="{{ product.featured_image | image_url: width: 620 }}"
          data-product-url="{{ product.url }}"
          aria-label="Quick view for {{ product.title }}"
        >
          <div class="quick-view-icon" width="20" height="20">
            {{ 'eye.svg' | inline_asset_content }}
          </div>
        </button>
      {%- endif -%}
    </div>
    <div class="m-product-card-bottom">
        <div class="m-product-card-title">
            <h3>
                <a href="{{ product.url }}" class="m-product-card-title-text">
                    {{ product.title }}
                </a>
            </h3>
        </div>
        <div class="m-product-card-price-wrap">
            <div class="m-product-card-price">
                {%- liquid
                  assign variant = product.selected_or_first_available_variant
                  assign compare_at_price = variant.compare_at_price
                  assign price = variant.price
                  
                  if settings.currency_code_enabled
                    assign money_price_base = price | money
                    assign money_compare_at_price_base = compare_at_price | money
                    assign currency_code = cart.currency.iso_code
                  else
                    assign money_price = price | money
                    assign money_compare_at_price = compare_at_price | money
                  endif
                  
                  assign is_on_sale = false
                  if compare_at_price > price
                    assign is_on_sale = true
                  endif
                  
                  assign show_promo = false
                  assign promo_price = price
                  assign promo_label = ''
                  
                  assign bf_diamond_classics_collection = 'diamond-classics'
                  assign bf_diamond_classics_percent = 70
                  
                  assign bf_diamond_pendants_collection = 'lab-grown-diamond-initial-pendant-necklaces'
                  assign bf_diamond_pendants_percent = 60
                  
                  assign bf_rolex_collection = 'pre-owned-rolex'
                  assign bf_rolex_fixed_amount_cents = 200000
                  
                  assign percent_offer_collections = "fine-jewelry,engagement,bands" | split: ","
                  assign percent_offer_value = 15
                  
                  assign in_bf_diamond_classics = false
                  assign in_bf_diamond_pendants = false
                  assign in_bf_rolex = false
                  assign in_percent_offer = false
                  
                  for c in product.collections
                    if c.handle == bf_diamond_classics_collection
                      assign in_bf_diamond_classics = true
                    endif
                    if c.handle == bf_diamond_pendants_collection
                      assign in_bf_diamond_pendants = true
                    endif
                    if c.handle == bf_rolex_collection
                      assign in_bf_rolex = true
                    endif
                    if percent_offer_collections contains c.handle
                      assign in_percent_offer = true
                    endif
                  endfor
                  
                  if in_bf_diamond_classics
                    assign percent_left = 100 | minus: bf_diamond_classics_percent
                    assign cand = price | times: percent_left | divided_by: 100
                    assign promo_price = cand
                    assign promo_label = 'Black Friday Diamond Classics'
                    assign show_promo = true
                  elsif in_bf_diamond_pendants
                    assign percent_left = 100 | minus: bf_diamond_pendants_percent
                    assign cand = price | times: percent_left | divided_by: 100
                    assign promo_price = cand
                    assign promo_label = 'Black Friday Diamond Pendants'
                    assign show_promo = true
                  elsif in_bf_rolex
                    assign cand = price | minus: bf_rolex_fixed_amount_cents
                    if cand < 0
                      assign cand = 0
                    endif
                    assign promo_price = cand
                    assign promo_label = 'Black Friday Pre-Owned Rolex'
                    assign show_promo = true
                  endif
                  
                  if in_percent_offer and show_promo == false
                    assign percent_left = 100 | minus: percent_offer_value
                    assign cand = price | times: percent_left | divided_by: 100
                    assign promo_price = cand
                    assign promo_label = '15% Off Launch Offer'
                    assign show_promo = true
                  endif
                  
                  if show_promo and promo_price < price
                    assign is_on_sale = true
                  endif
                -%}
                
                {%- if show_promo and promo_price < price -%}
                  {%- comment -%} Auto-discount price with original badge structure {%- endcomment -%}
                  <div class="promo-price-block price price--on-sale">
                    <div class="price__container">
                      <div class="price__sale">
                        <span class="price-item price-item--sale price-item--last">
                          {% if settings.currency_code_enabled %}
                            {{ promo_price | money }}<span class="m-product-card-currency-code">{{ currency_code }}</span>
                          {% else %}
                            {{ promo_price | money }}
                          {% endif %}
                        </span>
                        <span class="visually-hidden visually-hidden--inline">
                          {{ 'products.product.price.regular_price' | t }}
                        </span>
                        <span>
                          <s class="price-item price-item--regular">
                            {% if settings.currency_code_enabled %}
                              {{ price | money }}<span class="m-product-card-currency-code">{{ currency_code }}</span>
                            {% else %}
                              {{ price | money }}
                            {% endif %}
                          </s>
                        </span>
                        <span class="visually-hidden visually-hidden--inline">
                          {{ 'products.product.price.sale_price' | t }}
                        </span>
                      </div>
                    </div>

                    {%- if product.available -%}
                    <div class="promo-badge">
                        <ul class="discounts list-unstyled" role="list" aria-label="Discount">
                            <li class="discounts__discount">
                                <svg class="icon icon-discount" viewBox="0 0 12 12"><path fill="currentColor" fill-rule="evenodd" d="M7 0h3a2 2 0 0 1 2 2v3a1 1 0 0 1-.3.7l-6 6a1 1 0 0 1-1.4 0l-4-4a1 1 0 0 1 0-1.4l6-6A1 1 0 0 1 7 0m2 2a1 1 0 1 0 2 0 1 1 0 0 0-2 0" clip-rule="evenodd"></path></svg>
                                {{ promo_label }}
                            </li>
                        </ul>
                    </div>
                    {%- endif -%}
                  </div>
                {%- elsif is_on_sale and product.available -%}
                  {%- comment -%} Regular sale price with badge inline {%- endcomment -%}
                  <div class="price price--on-sale">
                    <div class="price__container">
                      <div class="price__sale">
                        <span class="price-item price-item--sale price-item--last">
                          {% if settings.currency_code_enabled %}
                            {{ money_price_base }}<span class="m-product-card-currency-code">{{ currency_code }}</span>
                          {% else %}
                            {{ money_price }}
                          {% endif %}
                        </span>
                        <span class="visually-hidden visually-hidden--inline">
                          {{ 'products.product.price.regular_price' | t }}
                        </span>
                        <div class="m-product-card-compare-badge-wrapper">
                          <span>
                            <s class="price-item price-item--regular">
                              {% if settings.currency_code_enabled %}
                                {{ money_compare_at_price_base }}<span class="m-product-card-currency-code">{{ currency_code }}</span>
                              {% else %}
                                {{ money_compare_at_price }}
                              {% endif %}
                            </s>
                          </span>
                          <span class="badge price__badge-sale color-{{ settings.sale_badge_color_scheme | default: 'accent-1' }} m-product-card-badge-inline">
                            {{ 'products.product.on_sale' | t }}
                          </span>
                        </div>
                        <span class="visually-hidden visually-hidden--inline">
                          {{ 'products.product.price.sale_price' | t }}
                        </span>
                      </div>
                    </div>
                  </div>
                {%- else -%}
                  {%- comment -%} Regular price (no sale) {%- endcomment -%}
                  <div class="price">
                    <div class="price__container">
                      <div class="price__regular">
                        <span class="visually-hidden visually-hidden--inline">
                          {{ 'products.product.price.regular_price' | t }}
                        </span>
                        <span class="price-item price-item--regular">
                          {% if settings.currency_code_enabled %}
                            {{ money_price_base }}<span class="m-product-card-currency-code">{{ currency_code }}</span>
                          {% else %}
                            {{ money_price }}
                          {% endif %}
                        </span>
                      </div>
                    </div>
                  </div>
                {%- endif -%}
            </div>
        </div>
        <div class="m-product-card-add-to-cart no-js-hidden">
            {%- if product.available == false -%}
                <button
                    type="button"
                    class="m-product-card-notify-me-btn"
                    data-product-notify-trigger
                    data-product-id="{{ product.id }}"
                    data-product-title="{{ product.title | escape }}"
                    data-product-handle="{{ product.handle }}"
                    onclick="event.stopPropagation();"
                >
                    <span class="m-product-card-notify-me-text">Notify Me</span>
                </button>
            {%- elsif product.variants_count > 1 or qty_rules -%}
                <modal-opener data-modal="#QuickAdd-{{ product.id }}">
                    <button
                        id="{{ product_form_id }}-submit"
                        type="button"
                        class="m-product-card-add-to-cart-btn button button--full-width button--secondary"
                        aria-haspopup="dialog"
                        aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ product.id }}"
                        data-product-url="{{ product.url }}"
                        onclick="event.stopPropagation();"
                    >
                        <span class="m-product-card-add-to-cart-text">Add to Cart</span>
                        {%- render 'loading-spinner' -%}
                    </button>
                </modal-opener>
                <quick-add-modal id="QuickAdd-{{ product.id }}" class="quick-add-modal">
                    <div
                        role="dialog"
                        aria-label="{{ 'products.product.choose_product_options' | t: product_name: product.title | escape }}"
                        aria-modal="true"
                        class="quick-add-modal__content global-settings-popup"
                        tabindex="-1"
                    >
                        <button
                            id="ModalClose-{{ product.id }}"
                            type="button"
                            class="quick-add-modal__toggle"
                            aria-label="{{ 'accessibility.close' | t }}"
                        >
                            {{- 'icon-close.svg' | inline_asset_content -}}
                        </button>
                        <div id="QuickAddInfo-{{ product.id }}" class="quick-add-modal__content-info"></div>
                    </div>
                </quick-add-modal>
            {%- else -%}
                <product-form data-section-id="{{ section.id }}">
                    {%- form 'product',
                        product,
                        id: product_form_id,
                        class: 'form',
                        novalidate: 'novalidate',
                        data-type: 'add-to-cart-form'
                    -%}
                        <input
                            type="hidden"
                            name="id"
                            value="{{ product.selected_or_first_available_variant.id }}"
                            class="product-variant-id"
                            {% if product.selected_or_first_available_variant.available == false %}
                                disabled
                            {% endif %}
                        >
                        <button
                            id="{{ product_form_id }}-submit"
                            type="submit"
                            name="add"
                            class="m-product-card-add-to-cart-btn"
                            aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ product.id }}"
                            aria-live="polite"
                            data-sold-out-message="true"
                            {% if product.selected_or_first_available_variant.available == false %}
                                disabled
                            {% endif %}
                        >
                            <span class="m-product-card-add-to-cart-text">Add to Cart</span>
                            {%- render 'loading-spinner' -%}
                        </button>
                    {%- endform -%}
                </product-form>
            {%- endif -%}
        </div>
    </div>
</div>
