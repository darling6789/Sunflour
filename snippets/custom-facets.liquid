{% comment %}
  Custom Data-Attribute Based Facets with Drawer Design
  Matches Shopify's facets.liquid structure for consistency

  Configuration:
  - window.customFilterConfig: Array of filter objects
    { name: 'filter-name', dataAttr: 'data-attribute', label: 'Filter Label' }
{% endcomment %}

{{ 'component-facets.css' | asset_url | stylesheet_tag }}

<div class="facets-container facets-container-drawer scroll-trigger animate--fade-in">
  <!-- DRAWER FILTER PANEL -->
  <menu-drawer class="mobile-facets__wrapper" data-breakpoint="mobile">
    <details class="mobile-facets__disclosure disclosure-has-popup">
      <!-- Filter Button -->
      <summary class="mobile-facets__open-wrapper focus-offset">
        <span class="mobile-facets__open">
          <span class="svg-wrapper">
            <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 34 34" fill="none">
              <path d="M0.454552 26.0909V29.7273H11.3636V26.0909H0.454552ZM0.454552 4.27272V7.90908H18.6364V4.27272H0.454552ZM18.6364 33.3636V29.7273H33.1818V26.0909H18.6364V22.4545H15V33.3636H18.6364ZM7.72728 11.5454V15.1818H0.454552V18.8182H7.72728V22.4545H11.3636V11.5454H7.72728ZM33.1818 18.8182V15.1818H15V18.8182H33.1818ZM22.2727 11.5454H25.9091V7.90908H33.1818V4.27272H25.9091V0.636353H22.2727V11.5454Z" fill="#69575F"></path>
            </svg>
          </span>
          <span class="mobile-facets__open-label button-label">
            Show Filters
          </span>
        </span>
        <span tabindex="0" class="mobile-facets__close">
          <span class="svg-wrapper">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" class="icon icon-close" viewBox="0 0 18 17"><path fill="currentColor" d="M.865 15.978a.5.5 0 0 0 .707.707l7.433-7.431 7.579 7.282a.501.501 0 0 0 .846-.37.5.5 0 0 0-.153-.351L9.712 8.546l7.417-7.416a.5.5 0 1 0-.707-.708L8.991 7.853 1.413.573a.5.5 0 1 0-.693.72l7.563 7.268z"></path></svg>
          </span>
        </span>
      </summary>

      <!-- Drawer Content -->
      <facet-filters-form>
        <form id="CustomFacetFiltersForm" class="mobile-facets">
          <div class="mobile-facets__inner gradient">
            <!-- Main Filter List View -->
            <div id="FacetsMainView" class="facets-view facets-view-active">
              <!-- Drawer Header -->
              <div class="mobile-facets__header">
                <div class="mobile-facets__header-inner">
                  <h2 class="mobile-facets__heading">Filters</h2>
                  <p class="mobile-facets__count" id="filter-product-count">0 products</p>
                </div>
              </div>

              <!-- Filter Categories List -->
              <div id="FacetsWrapperMobile" class="mobile-facets__main">
                <!-- Filter categories generated by JavaScript -->
              </div>

              <!-- Drawer Footer -->
              <div class="mobile-facets__footer">
                <facet-remove class="mobile-facets__clear-wrapper">
                  <a href="javascript:void(0)" class="mobile-facets__clear underlined-link" data-clear-all-filters role="button" tabindex="0">
                    Clear All
                  </a>
                </facet-remove>
                <button type="button" class="button button--primary" onclick="this.closest('.mobile-facets__wrapper').querySelector('summary').click()">
                  Apply
                </button>
              </div>
            </div>

            <!-- Filter Details View (Nested navigation) -->
            <div id="FacetsDetailView" class="facets-view">
              <!-- Header with back button -->
              <div class="mobile-facets__header">
                <button type="button" class="mobile-facets__back-button" id="facets-back-btn">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" class="icon icon-arrow" viewBox="0 0 14 10"><path fill="currentColor" fill-rule="evenodd" d="M8.537.808a.5.5 0 0 1 .817-.162l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 1 1-.708-.708L11.793 5.5H1a.5.5 0 0 1 0-1h10.793L8.646 1.354a.5.5 0 0 1-.109-.546" clip-rule="evenodd"></path></svg>
                  <span id="facets-detail-title">Filter</span>
                </button>
              </div>

              <!-- Filter options list -->
              <div id="FacetsDetailContent" class="mobile-facets__main">
                <!-- Checkboxes for specific filter generated by JavaScript -->
              </div>

              <!-- Detail Footer -->
              <div class="mobile-facets__footer">
                <facet-remove class="mobile-facets__clear-wrapper">
                  <a href="javascript:void(0)" class="mobile-facets__clear-filter underlined-link" role="button" tabindex="0">
                    Clear
                  </a>
                </facet-remove>
                <button type="button" class="button button--primary" id="facets-apply-filter-btn">
                  Apply
                </button>
              </div>
            </div>
          </div>
        </form>
      </facet-filters-form>
    </details>
  </menu-drawer>
</div>

<script>
  (function() {
    const DEBUG = true; // Set to false in production

    let filterConfig = window.customFilterConfig || [];
    let selectedFilters = {};
    let allProducts = [];
    let currentDetailFilter = null; // Track which filter detail view is showing

    // ==================== INITIALIZATION ====================
    let initialized = false; // Guard against multiple initializations

    function init() {
      if (initialized) {
        logWarn('Filter already initialized, skipping duplicate init');
        return;
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeFilters);
      } else {
        initializeFilters();
      }
    }

    function initializeFilters() {
      if (initialized) {
        logWarn('Filter already initialized, skipping duplicate init');
        return;
      }

      initialized = true;

      try {
        allProducts = document.querySelectorAll('[data-product-grid] .product-card-wrapper');

        if (allProducts.length === 0) {
          logError('No product cards found in [data-product-grid]');
          return;
        }

        if (filterConfig.length === 0) {
          logError('No filter configuration provided in window.customFilterConfig');
          return;
        }

        logInfo('Initializing filters', {
          productCount: allProducts.length,
          filterCount: filterConfig.length,
          filters: filterConfig
        });

        // Build filter UI
        buildFilterStructure();

        // Attach all event listeners
        attachAllListeners();

        // Update initial product count
        updateProductCount();

        logInfo('Filter initialization complete');
      } catch (error) {
        logError('Initialization failed', error);
        initialized = false;
      }
    }

    // ==================== FILTER STRUCTURE BUILDING ====================
    function buildFilterStructure() {
      const wrapper = document.getElementById('FacetsWrapperMobile');
      if (!wrapper) {
        logError('FacetsWrapperMobile element not found');
        return;
      }

      wrapper.innerHTML = '';

      filterConfig.forEach((config, configIndex) => {
        try {
          // Collect values and count products
          const valueMap = new Map();

          allProducts.forEach(card => {
            const value = card.getAttribute(config.dataAttr);
            if (value && value.trim()) {
              const trimmed = value.trim();
              valueMap.set(trimmed, (valueMap.get(trimmed) || 0) + 1);
            }
          });

          if (valueMap.size === 0) {
            logWarn(`No values found for filter: ${config.name}`);
            return;
          }

          // Store filter data for later use
          config.valueMap = valueMap;

          // Create a simple category button (not expandable)
          const categoryButton = createCategoryButton(config, configIndex);
          wrapper.appendChild(categoryButton);

          logInfo(`Filter category built: ${config.label} (${valueMap.size} options)`);
        } catch (error) {
          logError(`Error building filter: ${config.name}`, error);
        }
      });
    }

    function createCategoryButton(config, configIndex) {
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'mobile-facets__category-button';
      button.innerHTML = `
        <span class="mobile-facets__category-label">${escapeHtml(config.label)}</span>
        <span class="mobile-facets__category-arrow">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" class="icon icon-arrow" viewBox="0 0 14 10">
            <path fill="currentColor" fill-rule="evenodd" d="M8.537.808a.5.5 0 0 1 .817-.162l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 1 1-.708-.708L11.793 5.5H1a.5.5 0 0 1 0-1h10.793L8.646 1.354a.5.5 0 0 1-.109-.546" clip-rule="evenodd"></path>
          </svg>
        </span>
      `;

      button.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        showFilterDetail(config);
      }, false);

      return button;
    }

    // ==================== VIEW NAVIGATION ====================
    function showFilterDetail(config) {
      currentDetailFilter = config;

      // Update header
      document.getElementById('facets-detail-title').textContent = config.label;

      // Build detail content
      const detailContent = document.getElementById('FacetsDetailContent');
      detailContent.innerHTML = '';

      const ul = document.createElement('ul');
      ul.className = 'facets-layout facets-layout-list facets-layout-list--text mobile-facets__list list-unstyled';
      ul.setAttribute('role', 'list');

      // Add sorted filter items
      Array.from(config.valueMap.entries())
        .sort((a, b) => a[0].localeCompare(b[0]))
        .forEach((entry, itemIndex) => {
          const [value, count] = entry;
          const li = createFilterItem(config.name, value, count, itemIndex);
          ul.appendChild(li);
        });

      detailContent.appendChild(ul);

      // Switch to detail view with smooth transition
      switchView('detail');

      logInfo('Showing filter detail', { filterName: config.label, options: config.valueMap.size });
    }

    function showMainFilters() {
      currentDetailFilter = null;
      switchView('main');
      logInfo('Returned to main filter view');
    }

    function switchView(viewType) {
      const mainView = document.getElementById('FacetsMainView');
      const detailView = document.getElementById('FacetsDetailView');

      logInfo('switchView called', { viewType, mainViewExists: !!mainView, detailViewExists: !!detailView });

      if (!mainView || !detailView) {
        logError('View elements not found', { mainView: !!mainView, detailView: !!detailView });
        return;
      }

      if (viewType === 'detail') {
        mainView.classList.remove('facets-view-active');
        detailView.classList.add('facets-view-active');
        logInfo('Switched to detail view', {
          mainActive: mainView.classList.contains('facets-view-active'),
          detailActive: detailView.classList.contains('facets-view-active')
        });
      } else {
        mainView.classList.add('facets-view-active');
        detailView.classList.remove('facets-view-active');
        logInfo('Switched to main view', {
          mainActive: mainView.classList.contains('facets-view-active'),
          detailActive: detailView.classList.contains('facets-view-active')
        });
      }
    }

    function createFilterItem(filterName, value, count, index) {
      const li = document.createElement('li');
      li.className = 'mobile-facets__item list-menu__item';

      const inputId = `Filter-${filterName}-mobile-${index}`;

      const label = document.createElement('label');
      label.htmlFor = inputId;
      label.className = 'facets__label mobile-facets__label';

      // Checkbox input
      const input = document.createElement('input');
      input.type = 'checkbox';
      input.id = inputId;
      input.name = filterName;
      input.value = value;
      input.className = 'mobile-facets__checkbox custom-filter-checkbox';

      // Highlight span (for mobile visual feedback)
      const highlight = document.createElement('span');
      highlight.className = 'mobile-facets__highlight';

      // Square checkbox icon
      const checkboxIcon = document.createElement('svg');
      checkboxIcon.setAttribute('width', '16px');
      checkboxIcon.setAttribute('height', '16px');
      checkboxIcon.setAttribute('viewBox', '0 0 16 16');
      checkboxIcon.innerHTML = '<rect width="16" height="16" fill="none" stroke="currentColor"></rect>';

      // Checkmark icon
      const checkmarkIcon = document.createElement('svg');
      checkmarkIcon.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
      checkmarkIcon.setAttribute('fill', 'none');
      checkmarkIcon.setAttribute('class', 'icon icon-checkmark');
      checkmarkIcon.setAttribute('viewBox', '0 0 12 9');
      checkmarkIcon.innerHTML = '<path fill="currentColor" fill-rule="evenodd" d="M11.35.643a.5.5 0 0 1 .006.707l-6.77 6.886a.5.5 0 0 1-.719-.006L.638 4.845a.5.5 0 1 1 .724-.69l2.872 3.011 6.41-6.517a.5.5 0 0 1 .707-.006z" clip-rule="evenodd"></path>';

      // Label text with count
      const displayValue = capitalizeFilterDisplay(value);
      const textSpan = document.createElement('span');
      textSpan.className = 'facet-checkbox__text';
      textSpan.setAttribute('aria-hidden', 'true');
      textSpan.innerHTML = `<span class="facet-checkbox__text-label">${escapeHtml(displayValue)}</span> (${count})`;

      // Screen reader text
      const hiddenSpan = document.createElement('span');
      hiddenSpan.className = 'visually-hidden';
      hiddenSpan.textContent = `${displayValue} (${count} product${count !== 1 ? 's' : ''})`;

      // Assemble label
      label.appendChild(input);
      label.appendChild(highlight);
      label.appendChild(checkboxIcon);
      label.appendChild(checkmarkIcon);
      label.appendChild(textSpan);
      label.appendChild(hiddenSpan);

      li.appendChild(label);
      return li;
    }

    // ==================== EVENT LISTENERS ====================
    function attachAllListeners() {
      // Back button handler - attach directly to button with strong event control
      const backBtn = document.getElementById('facets-back-btn');
      if (backBtn) {
        logInfo('Back button found, attaching handler');
        backBtn.addEventListener('click', handleBackButtonClick, false);
      } else {
        logError('Back button NOT found with id="facets-back-btn"');
      }

      // Clear filter (in detail view) button - attach directly
      const clearFilterBtn = document.querySelector('.mobile-facets__clear-filter');
      if (clearFilterBtn) {
        logInfo('Clear filter button found, attaching handler');
        clearFilterBtn.addEventListener('click', handleClearFilterClick, false);
      } else {
        logWarn('Clear filter button not found');
      }

      // Checkbox change events
      document.addEventListener('change', handleCheckboxChange, false);

      // Clear all button
      document.addEventListener('click', handleClearAll, false);

      // Clear individual filter buttons (legacy, for main view)
      document.addEventListener('click', handleClearFilter, false);

      logInfo('All event listeners attached');
    }

    function handleBackButtonClick(e) {
      logInfo('handleBackButtonClick fired', {
        eventType: e.type,
        target: e.target.tagName,
        currentTarget: e.currentTarget.tagName
      });
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      logInfo('Back button click - calling showMainFilters()');
      showMainFilters();
      return false;
    }

    function handleClearFilterClick(e) {
      e.preventDefault();
      e.stopPropagation();
      if (currentDetailFilter) {
        document.querySelectorAll(`.custom-filter-checkbox[name="${currentDetailFilter.name}"]`).forEach(cb => {
          cb.checked = false;
        });
        applyFilters();
      }
      return false;
    }

    function handleCheckboxChange(e) {
      if (e.target && e.target.classList.contains('custom-filter-checkbox')) {
        try {
          applyFilters();
        } catch (error) {
          logError('Error applying filters', error);
        }
      }
    }

    function handleClearAll(e) {
      if (e.target && e.target.getAttribute('data-clear-all-filters') !== null) {
        e.preventDefault();
        document.querySelectorAll('.custom-filter-checkbox').forEach(cb => {
          cb.checked = false;
        });
        applyFilters();
      }
    }

    function handleClearFilter(e) {
      if (e.target && e.target.getAttribute('data-clear-filter')) {
        e.preventDefault();
        const filterName = e.target.getAttribute('data-clear-filter');
        document.querySelectorAll(`.custom-filter-checkbox[name="${filterName}"]`).forEach(cb => {
          cb.checked = false;
        });
        applyFilters();
      }
    }

    // ==================== FILTERING LOGIC ====================
    function applyFilters() {
      selectedFilters = {};

      // Collect all checked filters
      document.querySelectorAll('.custom-filter-checkbox:checked').forEach(checkbox => {
        const name = checkbox.name;
        if (!selectedFilters[name]) {
          selectedFilters[name] = [];
        }
        selectedFilters[name].push(checkbox.value);
      });

      logInfo('Filters applied', selectedFilters);

      // Show/hide products with AND logic, respecting pagination
      let visibleCount = 0;
      let paginatedVisibleCount = 0;

      allProducts.forEach(card => {
        let shouldShow = true;

        // All selected filters must match
        filterConfig.forEach(config => {
          if (selectedFilters[config.name] && selectedFilters[config.name].length > 0) {
            const cardValue = card.getAttribute(config.dataAttr);
            if (!cardValue || !selectedFilters[config.name].includes(cardValue.trim())) {
              shouldShow = false;
            }
          }
        });

        // CRITICAL: Respect pagination - only show first 12 products
        // Products beyond index 12 should remain hidden to respect the pagination limit
        const productIndex = parseInt(card.getAttribute('data-product-index')) || 0;
        const isPaginationHidden = productIndex >= 12;

        if (shouldShow && !isPaginationHidden) {
          card.style.display = '';
          paginatedVisibleCount++;
          visibleCount++;
        } else {
          card.style.display = 'none';
          if (shouldShow) visibleCount++;
        }
      });

      logInfo('Filters applied with pagination respect', {
        selectedFilters,
        visibleCount,
        paginatedVisibleCount
      });

      updateProductCount(paginatedVisibleCount, visibleCount);
    }

    function updateProductCount(visible, total) {
      const countEl = document.getElementById('filter-product-count');
      if (countEl) {
        if (visible !== undefined && total !== undefined) {
          countEl.textContent = `${visible} of ${total} products`;
        } else {
          const visibleCards = Array.from(allProducts).filter(card => card.style.display !== 'none').length;
          countEl.textContent = `${visibleCards} of ${allProducts.length} products`;
        }
      }
    }

    // ==================== UTILITY FUNCTIONS ====================
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function capitalizeFilterDisplay(value) {
      // Replace hyphens with spaces and capitalize each word
      return value
        .replace(/-/g, ' ')
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ')
        .toUpperCase();
    }

    function logInfo(message, data = null) {
      if (DEBUG) {
        console.log(`[Custom Facets] ${message}`, data || '');
      }
    }

    function logWarn(message, data = null) {
      console.warn(`[Custom Facets] ${message}`, data || '');
    }

    function logError(message, error = null) {
      console.error(`[Custom Facets] ${message}`, error || '');
    }

    // ==================== START ====================
    init();
  })();
</script>

<style>
  /* View container management */
  .facets-view {
    display: none !important;
    flex-direction: column;
    height: 100%;
    width: 100%;
    pointer-events: none !important;
  }

  .facets-view-active {
    display: flex !important;
    pointer-events: auto !important;
    animation: fadeIn 0.3s ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  /* Filter inner styling */
  .mobile-facets__inner {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
  }

  /* Main filter category list */
  .mobile-facets__main {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
  }

  /* Filter category button styling */
  .mobile-facets__category-button {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 12px 16px;
    border: none;
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    background: transparent;
    cursor: pointer;
    font-size: inherit;
    line-height: 1;
    text-align: left;
    transition: background-color 0.2s ease;
  }

  .mobile-facets__category-button:hover {
    background-color: rgba(0, 0, 0, 0.02);
  }

  .mobile-facets__category-label {
    font-weight: 500;
    flex: 1;
  }

  .mobile-facets__category-arrow {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    width: 20px;
    height: 20px;
  }

  .mobile-facets__category-arrow svg {
    width: 14px;
    height: 10px;
  }

  /* Back button styling */
  .mobile-facets__back-button {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
    padding: 12px 16px;
    border: none;
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    background: transparent;
    cursor: pointer;
    font-size: inherit;
    line-height: 1;
    text-align: left;
    transition: background-color 0.2s ease;
    pointer-events: auto !important;
    z-index: 20 !important;
    position: relative;
  }

  .mobile-facets__back-button:hover {
    background-color: rgba(0, 0, 0, 0.02);
  }

  .mobile-facets__back-button:active {
    background-color: rgba(0, 0, 0, 0.05);
  }

  .mobile-facets__back-button svg {
    width: 14px;
    height: 10px;
    transform: rotate(180deg);
    flex-shrink: 0;
    pointer-events: none;
  }

  .mobile-facets__back-button span {
    font-weight: 500;
    flex: 1;
    pointer-events: none;
  }

  /* Checkbox list styling */
  .mobile-facets__list {
    display: flex;
    flex-direction: column;
    gap: 0;
    margin: 0;
    padding: 0;
    list-style: none;
  }

  .mobile-facets__item {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  /* Label styling with flex for checkbox icon alignment */
  .mobile-facets__label {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    cursor: pointer;
    transition: background-color 0.2s ease;
    border: none;
    background: transparent;
    width: 100%;
    text-align: left;
    font-size: inherit;
    line-height: 1.2;
    position: relative;
  }

  .mobile-facets__label:hover {
    background-color: rgba(0, 0, 0, 0.02);
  }

  /* Hide native checkbox input */
  .mobile-facets__checkbox {
    appearance: none;
    -webkit-appearance: none;
    width: 0;
    height: 0;
    margin: 0;
    padding: 0;
    opacity: 0;
    pointer-events: none;
    position: absolute;
  }

  /* Checkbox icons styling - first item (left side) */
  .mobile-facets__label svg {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
    color: currentColor;
  }

  /* First SVG is the empty checkbox */
  .mobile-facets__label > svg:first-of-type {
    order: 1;
  }

  /* Hide checkmark by default, show when checked */
  .mobile-facets__label .icon-checkmark {
    display: none;
    order: 3;
  }

  .mobile-facets__checkbox:checked ~ .icon-checkmark {
    display: block;
  }

  /* Text styling - single line, flex: 1 to grow */
  .facet-checkbox__text {
    flex: 1;
    font-weight: 400;
    color: #000;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    order: 2;
    min-width: 0;
  }

  .facet-checkbox__text-label {
    font-weight: 400;
    color: #000;
  }

  /* Header and footer styling */
  .mobile-facets__header {
    flex-shrink: 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    pointer-events: auto !important;
    z-index: 15 !important;
  }

  .mobile-facets__header-inner {
    padding: 12px 16px;
    pointer-events: auto !important;
  }

  .mobile-facets__heading {
    margin: 0;
    font-size: inherit;
    font-weight: 600;
  }

  .mobile-facets__count {
    margin: 4px 0 0 0;
    font-size: 0.85em;
    color: rgba(0, 0, 0, 0.6);
  }

  .mobile-facets__footer {
    flex-shrink: 0;
    display: flex;
    gap: 8px;
    padding: 12px 16px;
    border-top: 1px solid rgba(0, 0, 0, 0.08);
  }

  .mobile-facets__clear-wrapper {
    flex: 1;
  }

  .mobile-facets__clear,
  .mobile-facets__clear-filter {
    display: block;
    text-align: center;
  }

  .mobile-facets__footer .button {
    flex: 1;
  }
</style>
