{% assign collection = collections[section.settings.collection_handle] %}

{% comment %} Extract letters from product titles and create mapping {% endcomment %}
{% assign letter_product_map = '' %}
{% for product in collection.products %}
    {% assign product_title = product.title %}
    {% assign letter_match = product_title | split: '"' %}
    {% if letter_match.size > 1 %}
        {% assign letter = letter_match[1] %}
        {% assign letter_product_map = letter_product_map | append: letter | append: ':' | append: product.handle | append: ',' %}
    {% endif %}
{% endfor %}

{% assign letter_product_array = letter_product_map | split: ',' %}

{% comment %} Sort letters alphabetically and create arrays {% endcomment %}
{% assign sorted_letters = '' %}
{% assign sorted_handles = '' %}
{% assign all_letters = 'A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z' | split: ',' %}
{% for letter in all_letters %}
    {% for letter_product in letter_product_array %}
        {% unless letter_product == blank %}
            {% assign letter_handle = letter_product | split: ':' %}
            {% if letter_handle[0] == letter %}
                {% assign sorted_letters = sorted_letters | append: letter | append: ',' %}
                {% assign sorted_handles = sorted_handles | append: letter_handle[1] | append: ',' %}
                {% break %}
            {% endif %}
        {% endunless %}
    {% endfor %}
{% endfor %}

{% assign sorted_letters_array = sorted_letters | split: ',' %}
{% assign sorted_handles_array = sorted_handles | split: ',' %}


<div class="m-pendants-select-letter">
    <div class="m-pendants-select-letter-content">
        <!-- Left Side: Product Image/Video -->
        <div class="m-pendants-select-letter-media">
            <div class="m-pendants-media-toggle">
                <button class="m-pendants-media-btn active" data-media="image">Image</button>
                <button class="m-pendants-media-btn" data-media="video">Video</button>
            </div>
            <div class="m-pendants-media-display">
                {% for i in (0..sorted_letters_array.size) %}
                    {% unless i >= sorted_letters_array.size %}
                        {% assign letter = sorted_letters_array[i] %}
                        {% assign handle = sorted_handles_array[i] %}
                        {% unless letter == blank %}
                            {% for product in collection.products %}
                                {% if product.handle == handle %}
                                    <!-- Image for {{ letter }} -->
                                    <div class="m-pendants-media-image{% if letter == 'A' %} active{% endif %}" data-letter="{{ letter }}">
                                        <img src="{{ product.featured_image | img_url: 'master' }}" alt="{{ letter }} Pendant" width="100%" height="100%" />
                                    </div>
                                    
                                    <!-- Video for {{ letter }} -->
                                    <div class="m-pendants-media-video" data-letter="{{ letter }}">
                                        {% if product.media[1].media_type == 'video' %}
                                            {{ product.media[1] | media_tag: image_size: '2048x', autoplay: true, loop: true, controls: false, preload: 'none' }}
                                        {% else %}
                                            <div class="no-video-message">No video available for {{ letter }}</div>
                                        {% endif %}
                                    </div>
                                    {% break %}
                                {% endif %}
                            {% endfor %}
                        {% endunless %}
                    {% endunless %}
                {% endfor %}
            </div>
        </div>

        <!-- Right Side: Text and Letter Selection -->
        <div class="m-pendants-select-letter-info">
            <h3 class="m-pendants-select-heading">{{ section.settings.heading }}</h3>
            <h2 class="m-pendants-select-subheading">{{ section.settings.subheading }}</h2>
            <p class="m-pendants-select-description">{{ section.settings.description }}</p>
            
            <!-- Letters Board -->
            <div class="m-pendants-letters-board">
                {% for i in (0..sorted_letters_array.size) %}
                    {% unless i >= sorted_letters_array.size %}
                        {% assign letter = sorted_letters_array[i] %}
                        {% assign handle = sorted_handles_array[i] %}
                        {% unless letter == blank %}
                            {% if letter == 'A' %}
                                <button class="m-pendants-letter-btn active" data-letter="{{ letter }}" data-product-handle="{{ handle }}">
                                    {{ letter }}
                                </button>
                            {% else %}
                                <button class="m-pendants-letter-btn" data-letter="{{ letter }}" data-product-handle="{{ handle }}">
                                    {{ letter }}
                                </button>
                            {% endif %}
                        {% endunless %}
                    {% endunless %}
                {% endfor %}
            </div>
            
            <!-- CTA Button -->
            <div class="m-pendants-select-cta">
                <button type="button" class="m-pendants-select-cta-btn" id="m-pendants-review-cta">
                    Review & Add to Cart
                </button>
            </div>
        </div>
    </div>
</div>

<div class="m-pendants-selected-detail">
    <div class="m-pendants-selected-detail-content">
        <!-- Left Side: Size Descriptions -->
        <div class="m-pendants-size-info">
            <h3 class="m-pendants-size-heading">{{ section.settings.size_heading }}</h3>
            <h2 class="m-pendants-size-subheading">{{ section.settings.size_subheading }}</h2>
            
            <div class="m-pendants-size-descriptions">
                <div class="m-pendants-size-classic">
                    <h4>{{ section.settings.classic_title }}</h4>
                    <p>{{ section.settings.classic_description }}</p>
                </div>
                <div class="m-pendants-size-luxe">
                    <h4>{{ section.settings.luxe_title }}</h4>
                    <p>{{ section.settings.luxe_description }}</p>
                </div>
            </div>
            
            <!-- CTA Button -->
            <div class="m-pendants-size-cta">
                <button type="button" class="m-pendants-size-cta-btn" id="m-pendants-select-size-cta">
                    Select Your Size
                </button>
            </div>
        </div>

        <!-- Right Side: Pendant Size Comparison Carousel -->
        <div class="m-pendants-comparison-carousel">
            <div class="m-pendants-carousel-container">
                <div class="m-pendants-carousel-slider">
                    <div class="m-pendants-carousel-slide active">
                        <div class="m-pendants-comparison-image">
                            {% if section.settings.comparison_image_1 %}
                                <img src="{{ section.settings.comparison_image_1 | img_url: 'master' }}" alt="Comparison Image 1" width="100%" height="100%" />
                            {% endif %}
                        </div>
                        <div class="m-pendants-comparison-labels">
                            <span class="m-pendants-luxe-label">{{ section.settings.luxe_label }}</span>
                            &nbsp; · &nbsp;
                            <span class="m-pendants-classic-label">{{ section.settings.classic_label }}</span>
                        </div>
                    </div>
                    <div class="m-pendants-carousel-slide">
                        <div class="m-pendants-comparison-image">
                            {% if section.settings.comparison_image_2 %}
                                <img src="{{ section.settings.comparison_image_2 | img_url: 'master' }}" alt="Comparison Image 2" width="100%" height="100%" />
                            {% endif %}
                        </div>
                        <div class="m-pendants-comparison-labels">
                            <span class="m-pendants-luxe-label">{{ section.settings.luxe_label }}</span>
                            &nbsp; · &nbsp;
                            <span class="m-pendants-classic-label">{{ section.settings.classic_label }}</span>
                        </div>
                    </div>
                </div>
                <div class="m-pendants-carousel-navigation">
                    <div class="m-pendants-carousel-prev">{% render 'icon-carousel-left-arrow' %}</div>
                    <div class="m-pendants-carousel-next">{% render 'icon-carousel-right-arrow' %}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.m-pendants-select-letter-section {
    width: 100%;
    background-color: #FFFFFF;
}

.m-pendants-select-letter-content {
    width: 100%;
    padding: 100px 40px;
    max-width: 1160px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 40px;
}

.m-pendants-select-letter-media {
    width: 50%;
    position: relative;
    max-width: 470px;
}

.m-pendants-media-toggle {
    display: flex;
    margin-bottom: 20px;
    gap: 10px;
}

.m-pendants-media-btn {
    padding: 8px 16px;
    border: 1px solid #E0E0E0;
    background: #FFFFFF;
    color: #666666;
    font-family: Montserrat;
    font-size: 14px;
    font-weight: 400;
    cursor: pointer;
    transition: all 0.3s ease;
}

.m-pendants-media-btn.active {
    background: #000000;
    color: #FFFFFF;
    border-color: #000000;
}

.m-pendants-media-display {
    position: relative;
    width: 100%;
    height: 470px;
    max-height: calc(100vw - 40px);
}

.m-pendants-media-image,
.m-pendants-media-video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    transition: opacity 0.3s ease;
    box-shadow: 0 25px 50px 0 rgba(0, 0, 0, 0.15);
}

.m-pendants-media-image.active,
.m-pendants-media-video.active {
    opacity: 1;
}

.no-video-message {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #666;
    font-style: italic;
}

.m-pendants-media-image img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.m-pendants-media-video video {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.m-pendants-select-letter-info {
    width: 50%;
    max-width: 470px;
}

.m-pendants-select-heading {
    color: #151515;
    font-family: Montserrat;
    font-size: 20px;
    font-style: normal;
    font-weight: 400;
    line-height: 24px; /* 120% */
    letter-spacing: 4.8px;
    text-transform: uppercase;
    margin: 0;
    margin-bottom: 30px;
    opacity: 0.6;
}

.m-pendants-select-subheading {
    color: #151515;
    font-family: "High Tower Text";
    font-size: 26px;
    font-style: italic;
    font-weight: 400;
    line-height: 24px; /* 92.308% */
    margin: 0 0 30px 0;
}

.m-pendants-select-description {
    color: #151515;
    font-family: Montserrat;
    font-size: 16px;
    font-style: normal;
    font-weight: 400;
    line-height: 38px; /* 237.5% */
    margin: 0 0 50px 0;
    opacity: 0.7;
}

.m-pendants-letters-board {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(45px, 1fr));
    gap: 8px;
    max-width: 470px;
}

.m-pendants-letter-btn {
    width: 45px;
    height: 45px;
    border: 1px solid #E5E7EB;
    background: #FFFFFF;
    color: #151515;
    text-align: center;
    font-family: Arial;
    font-size: 16px;
    font-style: normal;
    font-weight: 400;
    line-height: 24px; /* 150% */
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.m-pendants-letter-btn:hover {
    transform: scale(1.05);
    border-color: #000000;
}

.m-pendants-letter-btn.active {
    background: #000000;
    color: #FFFFFF;
    border-color: #000000;
}

.m-pendants-select-cta {
    margin-top: 40px;
    width: 100%;
    max-width: 470px;
}

.m-pendants-select-cta-btn {
    padding: 20px 40px;
    border-radius: 8px;
    background: #151515;
    color: #FFF;
    font-family: Montserrat;
    font-size: 16px;
    font-style: normal;
    font-weight: 400;
    line-height: 20px;
    outline: none;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.m-pendants-select-cta-btn:hover {
    background: #333333;
}

.m-pendants-select-cta-btn:active {
    transform: scale(0.98);
}

.m-pendants-selected-detail {
    width: 100%;
    background-color: #000000;
    padding: 100px 40px;
}

.m-pendants-selected-detail-content {
    width: 100%;
    max-width: 1080px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 40px;
}

.m-pendants-size-info {
    width: 55%;
}

.m-pendants-size-heading {
    opacity: 0.6;
    color: #FFF;
    font-family: Montserrat;
    font-size: 20px;
    font-style: normal;
    font-weight: 400;
    line-height: 24px; /* 120% */
    letter-spacing: 4.8px;
    text-transform: uppercase;
    margin: 0 0 30px 0;
}

.m-pendants-size-subheading {
    color: #FFF;
    font-family: "High Tower Text";
    font-size: 26px;
    font-style: italic;
    font-weight: 400;
    line-height: 24px; /* 92.308% */
    margin: 0 0 30px 0;
}

.m-pendants-size-descriptions {
    display: flex;
    flex-direction: column;
    gap: 30px;
}

.m-pendants-size-classic,
.m-pendants-size-luxe {
    padding-left: 26px;
    border-left: 2px solid rgba(255, 255, 255, 0.20);
}

.m-pendants-size-classic h4,
.m-pendants-size-luxe h4 {
    color: #FFF;
    font-family: Montserrat;
    font-size: 18px;
    font-style: normal;
    font-weight: 400;
    line-height: 24px; /* 133.333% */font-family: Montserrat;
    margin: 0 0 10px 0;
}

.m-pendants-size-classic p,
.m-pendants-size-luxe p {
    opacity: 0.7;
    color: #FFF;
    font-family: Montserrat;
    font-size: 16px;
    font-style: normal;
    font-weight: 400;
    line-height: 30px; /* 187.5% */
    margin: 0;
}

.m-pendants-size-cta {
    margin-top: 40px;
    width: 100%;
}

.m-pendants-size-cta-btn {
    padding: 20px 40px;
    border-radius: 8px;
    background: #FFFFFF;
    color: #151515;
    font-family: Montserrat;
    font-size: 16px;
    font-style: normal;
    font-weight: 400;
    line-height: 20px;
    outline: none;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
}

.m-pendants-size-cta-btn:hover {
    background: #F5F5F5;
    transform: translateY(-2px);
}

.m-pendants-size-cta-btn:active {
    transform: scale(0.98);
}

.m-pendants-comparison-carousel {
    width: calc(45% - 40px);
    max-width: 450px;
}

.m-pendants-carousel-container {
    position: relative;
    width: 100%;
}

.m-pendants-carousel-slider {
    width: 100%;
}

.m-pendants-carousel-slide {
    display: none;
    text-align: center;
}

.m-pendants-carousel-slide.active {
    display: block;
}

.m-pendants-comparison-image {
    width: 100%;
    max-width: 400px;
    height: 400px;
    margin: auto;
    margin-bottom: 10px;
}

.m-pendants-comparison-image img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.m-pendants-comparison-labels {
    display: flex;
    justify-content: center;
    color: #FFFFFF;
    font-family: Montserrat;
    font-size: 14px;
    font-weight: 400;
}

.m-pendants-carousel-navigation {
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    display: flex;
    justify-content: space-between;
    pointer-events: none;
    transform: translateY(-50%);
}

.m-pendants-carousel-prev,
.m-pendants-carousel-next {
    pointer-events: auto;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.3s ease;
}

.m-pendants-carousel-prev:hover,
.m-pendants-carousel-next:hover {
    opacity: 1;
}

@media (max-width: 749px) {
    .m-pendants-select-letter-content {
        padding: 60px 20px;
    }

    .m-pendants-select-letter-content,
    .m-pendants-selected-detail-content {
        flex-direction: column;
        gap: 40px;
    }

    .m-pendants-select-description {
        line-height: 2;
    }
    
    .m-pendants-select-letter-media,
    .m-pendants-select-letter-info,
    .m-pendants-size-info,
    .m-pendants-comparison-carousel {
        width: 100%;
    }

    .m-pendants-letters-board {
        grid-template-columns: repeat(6, 1fr);
        max-width: 100%;
    }
    
    .m-pendants-select-cta {
        max-width: 100%;
    }

    .m-pendants-selected-detail {
        padding: 60px 20px;
    }
    .m-pendants-select-cta-btn, .m-pendants-size-cta-btn {
        display: block;
        margin: auto;
    }
}
</style>

<script>
$(document).ready(function(){
    // Media toggle functionality
    $('.m-pendants-media-btn').on('click', function(){
        const mediaType = $(this).data('media');
        
        $('.m-pendants-media-btn').removeClass('active');
        $(this).addClass('active');
        
        // Show/hide all media elements based on type and current letter
        const currentLetter = $('.m-pendants-letter-btn.active').data('letter');
        
        $('.m-pendants-media-image, .m-pendants-media-video').removeClass('active');
        $('.m-pendants-media-' + mediaType + '[data-letter="' + currentLetter + '"]').addClass('active');
        
        // Handle video play/pause
        if (mediaType === 'video') {
            const video = $('.m-pendants-media-video[data-letter="' + currentLetter + '"] video')[0];
            if (video) {
                const playPromise = video.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        // Video play was interrupted, ignore the error
                    });
                }
            }
        } else {
            // Pause all videos when switching to image
            $('.m-pendants-media-video video').each(function(){
                this.pause();
            });
        }
    });
    
    // Letter selection functionality
    $('.m-pendants-letter-btn').on('click', function(){
        const selectedLetter = $(this).data('letter');
        
        // Update active letter button
        $('.m-pendants-letter-btn').removeClass('active');
        $(this).addClass('active');
        
        // Show/hide media elements based on current media type and selected letter
        const currentMediaType = $('.m-pendants-media-btn.active').data('media');
        $('.m-pendants-media-image, .m-pendants-media-video').removeClass('active');
        $('.m-pendants-media-' + currentMediaType + '[data-letter="' + selectedLetter + '"]').addClass('active');
        
        // Handle video play/pause
        if (currentMediaType === 'video') {
            const video = $('.m-pendants-media-video[data-letter="' + selectedLetter + '"] video')[0];
            if (video) {
                const playPromise = video.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        // Video play was interrupted, ignore the error
                    });
                }
            }
        }
    });
    
    // Carousel navigation
    $('.m-pendants-carousel-prev').on('click', function(){
        const currentSlideIndex = $('.m-pendants-carousel-slide.active').index();
        const prevSlideIndex = currentSlideIndex - 1;
        
        if(prevSlideIndex >= 0){
            $('.m-pendants-carousel-slide').removeClass('active');
            $('.m-pendants-carousel-slide').eq(prevSlideIndex).addClass('active');
            $('.m-pendants-carousel-slider').slick('slickGoTo', prevSlideIndex);
        }
    });
    
    $('.m-pendants-carousel-next').on('click', function(){
        const currentSlideIndex = $('.m-pendants-carousel-slide.active').index();
        const nextSlideIndex = currentSlideIndex + 1;
        const totalSlides = $('.m-pendants-carousel-slide').length;
        
        if(nextSlideIndex < totalSlides){
            $('.m-pendants-carousel-slide').removeClass('active');
            $('.m-pendants-carousel-slide').eq(nextSlideIndex).addClass('active');
            $('.m-pendants-carousel-slider').slick('slickGoTo', nextSlideIndex);
        }
    });
    
    
    // Initialize slick slider for carousel
    $('.m-pendants-carousel-slider').slick({
        slidesToShow: 1,
        slidesToScroll: 1,
        infinite: true,
        arrows: true,
        dots: false,
        prevArrow: '.m-pendants-carousel-prev',
        nextArrow: '.m-pendants-carousel-next',
        fade: true,
        cssEase: 'linear'
    });
    
    // CTA Button - Scroll to product section
    $('#m-pendants-review-cta').on('click', function(){
        const productSection = document.querySelector('.m-pendants-product-section');
        if (productSection) {
            productSection.scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }
    });
    
    // Size CTA Button - Scroll to product section
    $('#m-pendants-select-size-cta').on('click', function(){
        const productSection = document.querySelector('.m-pendants-product-section');
        if (productSection) {
            productSection.scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }
    });
});
</script>

{% schema %}
{
    "name": "Pendants select letter",
    "tag": "section",
    "class": "m-pendants-select-letter-section",
    "settings": [
        {
            "type": "text",
            "id": "heading",
            "label": "Heading",
            "default": "SELECT YOUR LETTER"
        },
        {
            "type": "text",
            "id": "subheading",
            "label": "Subheading",
            "default": "Personalized Perfection"
        },
        {
            "type": "textarea",
            "id": "description",
            "label": "Description",
            "default": "Each letter is meticulously laser-cut from the finest lab-grown diamonds, creating a unique piece that celebrates your identity with unmatched brilliance."
        },
        {
            "type": "text",
            "id": "collection_handle",
            "label": "Collection Handle",
            "default": "lab-grown-diamond-initial-pendant-necklaces"
        },
        {
            "type": "video",
            "id": "product_video",
            "label": "Product Video"
        },
        {
            "type": "text",
            "id": "size_heading",
            "label": "Size Section Heading",
            "default": "TWO EXQUISITE SIZES"
        },
        {
            "type": "text",
            "id": "size_subheading",
            "label": "Size Section Subheading",
            "default": "Classic & Luxe"
        },
        {
            "type": "text",
            "id": "classic_title",
            "label": "Classic Size Title",
            "default": "Classic"
        },
        {
            "type": "textarea",
            "id": "classic_description",
            "label": "Classic Size Description",
            "default": "8mm width pendant crafted from a 3-carat lab-grown diamond. Perfect for everyday elegance and subtle sophistication."
        },
        {
            "type": "text",
            "id": "luxe_title",
            "label": "Luxe Size Title",
            "default": "Luxe"
        },
        {
            "type": "textarea",
            "id": "luxe_description",
            "label": "Luxe Size Description",
            "default": "10mm width pendant laser cut from a 5-carat lab-grown diamond. A bold statement piece that commands attention with extraordinary brilliance."
        },
        {
            "type": "text",
            "id": "luxe_label",
            "label": "Luxe Label",
            "default": "Luxe (Left)"
        },
        {
            "type": "text",
            "id": "classic_label",
            "label": "Classic Label",
            "default": "Classic (Right)"
        },
        {
            "type": "image_picker",
            "id": "comparison_image_1",
            "label": "Comparison Image 1"
        },
        {
            "type": "image_picker",
            "id": "comparison_image_2",
            "label": "Comparison Image 2"
        }
    ],
    "presets": [
        {
            "name": "Pendants select letter"
        }
    ]
}
{% endschema %}
